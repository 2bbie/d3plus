var vizwhiz=window.vizwhiz||{};vizwhiz.version="0.0.1",vizwhiz.dev=!0,window.vizwhiz=vizwhiz,vizwhiz.tooltip={},vizwhiz.utils={},vizwhiz.viz={},vizwhiz.evt={},Modernizr.touch?(vizwhiz.evt.click="touchend",vizwhiz.evt.down="touchstart",vizwhiz.evt.up="touchend",vizwhiz.evt.over="touchstart",vizwhiz.evt.out="touchend",vizwhiz.evt.move="touchmove"):(vizwhiz.evt.click="click",vizwhiz.evt.down="mousedown",vizwhiz.evt.up="mouseup",vizwhiz.evt.over="mouseover",vizwhiz.evt.out="mouseout",vizwhiz.evt.move="mousemove"),vizwhiz.utils.format_num=function(val,percent,sig_figs,abbrv){if(percent)val=d3.format("."+sig_figs+"p")(val);else if(abbrv){var symbol=d3.formatPrefix(val).symbol;symbol=symbol.replace("G","B"),val=d3.formatPrefix(val).scale(val),val=parseFloat(d3.format("."+sig_figs+"g")(val)),val=val+" "+symbol}else val=d3.format(",."+sig_figs+"d")(val);return val},vizwhiz.utils.color_scale=d3.scale.category20(),vizwhiz.utils.rand_color=function(){var rand_int=Math.floor(20*Math.random());return vizwhiz.utils.color_scale(rand_int)},vizwhiz.utils.merge=function(obj1,obj2){var obj3={};for(var attrname in obj1)obj3[attrname]=obj1[attrname];for(var attrname in obj2)obj3[attrname]=obj2[attrname];return obj3},vizwhiz.utils.wordWrap=function(text,parent,width,height,resize){function flow(){d3.select(parent).selectAll("tspan").remove();for(var tspan=d3.select(parent).append("tspan").attr("x",parent.getAttribute("x")).text(words[0]),i=1;words.length>i;i++)tspan.text(tspan.text()+" "+words[i]),tspan.node().getComputedTextLength()>width&&(tspan.text(tspan.text().substr(0,tspan.text().lastIndexOf(" "))),tspan=d3.select(parent).append("tspan").attr("x",parent.getAttribute("x")).text(words[i]))}function truncate(){for(var cut=!1;parent.childNodes.length*parent.getBBox().height>height;)parent.removeChild(parent.lastChild),cut=!0;if(cut&&0!=parent.childNodes.length){tspan=parent.lastChild,words=d3.select(tspan).text().split(/[\s-]/);var last_char=words[words.length-1].charAt(words[words.length-1].length-1);(","==last_char||";"==last_char||":"==last_char)&&(words[words.length-1]=words[words.length-1].substr(0,words[words.length-1].length-1)),d3.select(tspan).text(words.join(" ")+"..."),tspan.getComputedTextLength()>width&&(words.length>1&&words.pop(words.length-1),last_char=words[words.length-1].charAt(words[words.length-1].length-1),(","==last_char||";"==last_char||":"==last_char)&&words[words.length-1].substr(0,words[words.length-1].length-2),d3.select(tspan).text(words.join(" ")+"..."))}}var tspan,words=text.split(/[\s-]/),width=.9*width,height=.9*height;if(resize){var max_font_size=40,min_font_size=8,size=height;if(height>width)var size=width;d3.select(parent).attr("font-size",size);for(var text_width=0,i=0;words.length>i;i++)tspan=d3.select(parent).append("tspan").attr("x",0).attr("dx","0.15em").text(words[i]+" ..."),tspan.node().getComputedTextLength()>text_width&&(text_width=tspan.node().getComputedTextLength());if(text_width>width&&(size*=width/text_width),min_font_size>size)return d3.select(parent).selectAll("tspan").remove(),void 0;if(size>max_font_size&&(size=max_font_size),d3.select(parent).attr("font-size",size),flow(),parent.childNodes.length*parent.getBBox().height>height){var temp_size=size*(height/(parent.childNodes.length*parent.getBBox().height));size=min_font_size>temp_size?min_font_size:temp_size,d3.select(parent).attr("font-size",size)}}flow(),truncate(),d3.select(parent).selectAll("tspan").attr("dy",d3.select(parent).style("font-size"))},vizwhiz.viz.network=function(){function chart(selection){return selection.each(function(data){function position_links(l){l.attr("x1",function(d){return scale.x(d.source.x)}).attr("y1",function(d){return scale.y(d.source.y)}).attr("x2",function(d){return scale.x(d.target.x)}).attr("y2",function(d){return scale.y(d.target.y)})}function size_nodes(n){n.attr("cx",function(d){return scale.x(d.x)}).attr("cy",function(d){return scale.y(d.y)}).attr("r",function(d){var value=data[d[id_var]][value_var];return value>0?scale.size(value):scale.size(val_range[0])}).attr("stroke-width",function(d){return data[d[id_var]].active?2:1})}function size_bgs(b){b.attr("cx",function(d){return scale.x(d.x)}).attr("cy",function(d){return scale.y(d.y)}).attr("r",function(d){var value=data[d[id_var]][value_var],buffer=data[d[id_var]].active?3:2;return value=value>0?scale.size(value):scale.size(val_range[0]),value+buffer}).attr("stroke-width",0)}function color_nodes(n){n.attr("fill",function(d){var color=data[d[id_var]].color?data[d[id_var]].color:vizwhiz.utils.rand_color();return data[d[id_var]].active?(this.parentNode.appendChild(this),color):spotlight&&!highlight?"#eeeeee":(color=d3.hsl(color),color.l=.98,""+color)}).attr("stroke",function(d){var color=data[d[id_var]].color?data[d[id_var]].color:vizwhiz.utils.rand_color();return data[d[id_var]].active?""+d3.rgb(color).darker().darker():spotlight&&!highlight?"#dedede":""+d3.rgb(color).darker()})}function update(){if(highlight_group.selectAll("*").remove(),info_group.selectAll("*").remove(),highlight){node.attr("fill","#efefef").attr("stroke","#dedede");var center=connections[highlight].center,primaries=connections[highlight].primary,secondaries=connections[highlight].secondary;highlight_group.selectAll("line.sec_links").data(secondaries.links).enter().append("line").attr("class","sec_links").attr("stroke-width","1px").attr("stroke",secondary_color).call(position_links).on(vizwhiz.evt.click,function(){zoom("reset"),clicked=!1,update()}),highlight_group.selectAll("circle.sec_bgs").data(secondaries.nodes).enter().append("circle").attr("class","sec_bgs").attr("fill",secondary_color).call(size_bgs),highlight_group.selectAll("circle.sec_nodes").data(secondaries.nodes).enter().append("circle").attr("class","sec_nodes").call(size_nodes).attr("fill","#efefef").attr("stroke","#dedede").on(vizwhiz.evt.over,function(d){clicked?d3.select(this).attr("stroke",highlight_color):(highlight=d[id_var],update())}).on(vizwhiz.evt.out,function(){clicked&&d3.select(this).attr("stroke","#dedede")}).on(vizwhiz.evt.click,function(d){highlight=d[id_var],zoom(highlight),update()}),highlight_group.selectAll("line.prim_links").data(primaries.links).enter().append("line").attr("class","prim_links").attr("stroke",highlight_color).attr("stroke-width","2px").call(position_links).on(vizwhiz.evt.click,function(){zoom("reset"),clicked=!1,update()}),highlight_group.selectAll("circle.prim_bgs").data(primaries.nodes).enter().append("circle").attr("class","prim_bgs").call(size_bgs).attr("fill",highlight_color),highlight_group.selectAll("circle.prim_nodes").data(primaries.nodes).enter().append("circle").attr("class","prim_nodes").call(size_nodes).call(color_nodes).on(vizwhiz.evt.over,function(d){clicked||(highlight=d[id_var],update())}).on(vizwhiz.evt.click,function(d){highlight=d[id_var],zoom(highlight),update()}),highlight_group.selectAll("circle.center_bg").data([center]).enter().append("circle").attr("class","center_bg").call(size_bgs).attr("fill",select_color),highlight_group.selectAll("circle.center").data([center]).enter().append("circle").attr("class","center").call(size_nodes).call(color_nodes).on(vizwhiz.evt.out,function(){clicked||(highlight=null,update())}).on(vizwhiz.evt.click,function(){clicked?(zoom("reset"),clicked=!1,update()):(zoom(highlight),clicked=!0,update())});var d=data[highlight];if(scale.x(connections[highlight].extent.x[1])>width-info_width-5)var x_pos=37;else var x_pos=width-info_width;var bg=info_group.append("rect").attr("width",info_width+"px").attr("height",height-10+"px").attr("y","5px").attr("x",x_pos-5+"px").attr("ry","3").attr("fill","#dddddd"),text=info_group.append("text").attr("y","8px").attr("x",x_pos+"px").attr("fill","#333333").attr("text-anchor","start").style("font-weight","bold").attr("font-size","14px").attr("font-family","Helvetica").each(function(){vizwhiz.utils.wordWrap(d[text_var],this,info_width-10,info_width,!1)});if(clicked){for(var id in d)0>[text_var,"color","text_color","active"].indexOf(id)&&text.append("tspan").attr("dy","14px").attr("font-size","12px").attr("x",x_pos+"px").style("font-weight","normal").text(id+": "+d[id]);var y=text.node().getBBox().height+15,primary_title=info_group.append("text").attr("x",x_pos+"px").attr("y",y+"px").attr("dy","18px").attr("fill","#333333").attr("text-anchor","start").attr("font-size","12px").attr("font-family","Helvetica").attr("x",x_pos+"px").style("font-weight","bold").text("Primary Connections");y+=primary_title.node().getBBox().height+5;var prims=[],trunc=!1;connections[highlight].primary.nodes.forEach(function(c){prims.push(c[id_var])}),prims.forEach(function(c){if(!trunc){info_group.append("circle").attr("cx",x_pos+5+"px").attr("cy",y+8+"px").attr("r",5).attr("fill",function(){var color=data[c].color?data[c].color:vizwhiz.utils.rand_color();return data[c].active?color:(color=d3.hsl(color),color.l=.98,""+color)}).attr("stroke",function(){var color=data[c].color?data[c].color:vizwhiz.utils.rand_color();return data[c].active?""+d3.rgb(color).darker().darker():""+d3.rgb(color).darker()}).attr("stroke-width",function(){return data[c].active?2:1});var temp_title=info_group.append("text").attr("x",x_pos+13+"px").attr("y",y+"px").attr("fill","#333333").attr("text-anchor","start").attr("font-size","12px").attr("font-family","Helvetica").style("font-weight","normal").on(vizwhiz.evt.over,function(){d3.select(this).attr("fill",highlight_color).style("cursor","pointer")}).on(vizwhiz.evt.out,function(){d3.select(this).attr("fill","#333333")}).on(vizwhiz.evt.click,function(){highlight=c,zoom(highlight),update()}).each(function(){vizwhiz.utils.wordWrap(data[c][text_var],this,info_width-10,info_width,!1)});y+=temp_title.node().getBBox().height,y>height-40&&(trunc=!0)}}),bg.attr("height",y+"px")}else text.append("tspan").attr("dy","14px").attr("font-size","10px").attr("x",x_pos+"px").style("font-weight","normal").text("Click Node for More Info"),bg.attr("height",text.node().getBBox().height+10+"px")}else node.call(color_nodes)}function zoom(direction){var zoom_extent=zoom_behavior.scaleExtent();if(d3.event.scale)evt_scale=d3.event.scale,translate=d3.event.translate;else{if("in"==direction)multiplier=zoom_behavior.scale()>zoom_extent[1]/2?zoom_extent[1]/zoom_behavior.scale():2;else if("out"==direction)multiplier=zoom_behavior.scale()<2*zoom_extent[0]?zoom_extent[0]/zoom_behavior.scale():.5;else if(connections[direction]){var x_bounds=[scale.x(connections[direction].extent.x[0]),scale.x(connections[direction].extent.x[1])],y_bounds=[scale.y(connections[direction].extent.y[0]),scale.y(connections[direction].extent.y[1])];if(x_bounds[1]>width-info_width-5)var offset_left=info_width+32;else var offset_left=0;var w_zoom=(width-info_width-10)/(x_bounds[1]-x_bounds[0]),h_zoom=height/(y_bounds[1]-y_bounds[0]);h_zoom>w_zoom?(x_bounds=[x_bounds[0]-2*max_size,x_bounds[1]+2*max_size],evt_scale=(width-info_width-10)/(x_bounds[1]-x_bounds[0]),evt_scale>zoom_extent[1]&&(evt_scale=zoom_extent[1]),offset_x=-(x_bounds[0]*evt_scale),offset_y=-(y_bounds[0]*evt_scale)+(height-(y_bounds[1]-y_bounds[0])*evt_scale)/2):(y_bounds=[y_bounds[0]-2*max_size,y_bounds[1]+2*max_size],evt_scale=height/(y_bounds[1]-y_bounds[0]),evt_scale>zoom_extent[1]&&(evt_scale=zoom_extent[1]),offset_x=-(x_bounds[0]*evt_scale)+(width-info_width-10-(x_bounds[1]-x_bounds[0])*evt_scale)/2,offset_y=-(y_bounds[0]*evt_scale)),translate=[offset_x+offset_left,offset_y]}else"reset"==direction&&(translate=[0,0],evt_scale=1);if("in"==direction||"out"==direction){var trans=d3.select("g.viz")[0][0].getAttribute("transform");if(trans){trans=trans.split("(");var coords=trans[1].split(")");coords=coords[0].replace(" ",","),coords=coords.substring(0,trans[1].length-6).split(","),offset_x=parseFloat(coords[0]),offset_y=2==coords.length?parseFloat(coords[1]):parseFloat(coords[0]),zoom_var=parseFloat(trans[2].substring(0,trans[2].length-1))}else offset_x=0,offset_y=0,zoom_var=1;multiplier>.5&&1>=multiplier&&"out"==direction?(offset_x=0,offset_y=0):(offset_x=width/2-(width/2-offset_x)*multiplier,offset_y=height/2-(height/2-offset_y)*multiplier),translate=[offset_x,offset_y],evt_scale=zoom_var*multiplier}}zoom_behavior.translate(translate).scale(evt_scale),translate[0]>0?translate[0]=0:-(width*evt_scale-width)>translate[0]&&(translate[0]=-(width*evt_scale-width)),translate[1]>0?translate[1]=0:-(height*evt_scale-height)>translate[1]&&(translate[1]=-(height*evt_scale-height)),d3.event.scale?"mousewheel"==d3.event.sourceEvent.type||"mousemove"==d3.event.sourceEvent.type?d3.select(".viz").attr("transform","translate("+translate+")"+"scale("+evt_scale+")"):d3.select(".viz").transition().duration(timing).attr("transform","translate("+translate+")"+"scale("+evt_scale+")"):d3.select(".viz").transition().duration(4*timing).attr("transform","translate("+translate+")"+"scale("+evt_scale+")")}var this_selection=this,dragging=!1,highlight_color="#cc0000",select_color="#ee0000",secondary_color="#ffdddd",scale={},offset_top=0,offset_left=0,info_width=300,svg=d3.select(this_selection).selectAll("svg").data([data]),svg_enter=svg.enter().append("svg").attr("width",width).attr("height",height);if(aspect>width/height){var viz_height=width/aspect,viz_width=width;offset_top=(height-viz_height)/2}else{var viz_width=height*aspect,viz_height=height;offset_left=(width-viz_width)/2}var columns=Math.ceil(Math.sqrt(Object.keys(nodes).length*(viz_width/viz_height))),max_size=viz_width/(3*columns),min_size=2>max_size/5?2:max_size/5;scale.x=d3.scale.linear().domain(x_range).range([offset_left+2*max_size,width-2*max_size-offset_left]),scale.y=d3.scale.linear().domain(y_range).range([offset_top+2*max_size,height-2*max_size-offset_top]);var val_range=d3.extent(d3.values(data),function(d){return d[value_var]>0?d[value_var]:null});scale.size=d3.scale.log().domain(val_range).range([min_size,max_size]);var viz_enter=svg_enter.append("g").call(zoom_behavior.on("zoom",zoom)).on(vizwhiz.evt.down,function(){dragging=!0}).on(vizwhiz.evt.up,function(){dragging=!1}).append("g").attr("class","viz");viz_enter.append("rect").attr("class","overlay").attr("width",viz_width).attr("height",viz_height).attr("fill","transparent").on(vizwhiz.evt.over,function(){!clicked&&highlight&&(highlight=null,update())}).on(vizwhiz.evt.click,function(){clicked=null,highlight=null,zoom("reset"),update()});var link_group=viz_enter.append("g").attr("class","links"),node_group=viz_enter.append("g").attr("class","nodes"),highlight_group=viz_enter.append("g").attr("class","highlight"),info_group=svg_enter.append("g").attr("class","info"),zoom_div=svg.enter().append("div").attr("id","zoom_controls");zoom_div.append("div").attr("id","zoom_in").attr("unselectable","on").on(vizwhiz.evt.click,function(){zoom("in")}).text("+"),zoom_div.append("div").attr("id","zoom_out").attr("unselectable","on").on(vizwhiz.evt.click,function(){zoom("out")}).text("-");var node=node_group.selectAll("circle.node").data(nodes,function(d){return d[id_var]});node.enter().append("circle").attr("class","node").call(size_nodes).call(color_nodes).on(vizwhiz.evt.over,function(d){clicked?d3.select(this).attr("stroke",highlight_color):(highlight=d[id_var],update())}).on(vizwhiz.evt.out,function(){clicked&&d3.select(this).attr("stroke","#dedede")}).on(vizwhiz.evt.click,function(d){highlight=d[id_var],zoom(highlight),update()});var link=link_group.selectAll("line.link").data(links,function(d){return d.source[id_var]+"-"+d.target[id_var]});link.enter().append("line").attr("class","link").call(position_links).attr("stroke","#dedede").attr("stroke-width","1px").on(vizwhiz.evt.click,function(){clicked=null,highlight=null,zoom("reset"),update()}),node.transition().duration(timing).call(size_nodes).call(color_nodes),link.transition().duration(timing).call(position_links),d3.select(".overlay").transition().duration(timing).attr("width",viz_width).attr("height",viz_height),svg.transition().duration(timing).attr("width",width).attr("height",height),node.exit().remove(),link.exit().remove(),update(),highlight&&clicked&&zoom(highlight)}),chart}var x_range,y_range,aspect,width=300,height=300,value_var="value",id_var="id",text_var="name",clicked=!1,spotlight=!0,highlight=null,timing=100,zoom_behavior=d3.behavior.zoom().scaleExtent([1,16]),nodes=[],links=[],connections={};return chart.width=function(x){return arguments.length?(width=x,chart):width},chart.height=function(x){return arguments.length?(height=x,chart):height},chart.nodes=function(x){return arguments.length?(nodes=x,x_range=d3.extent(d3.values(nodes),function(d){return d.x}),y_range=d3.extent(d3.values(nodes),function(d){return d.y}),aspect=(x_range[1]-x_range[0])/(y_range[1]-y_range[0]),chart):nodes},chart.links=function(x){if(!arguments.length)return links;links=x,links.forEach(function(d){connections[d.source[id_var]]||(connections[d.source[id_var]]={},connections[d.source[id_var]].center=d.source,connections[d.source[id_var]].primary={nodes:[],links:[]}),connections[d.source[id_var]].primary.nodes.push(d.target),connections[d.source[id_var]].primary.links.push({source:d.source,target:d.target}),connections[d.target[id_var]]||(connections[d.target[id_var]]={},connections[d.target[id_var]].center=d.target,connections[d.target[id_var]].primary={nodes:[],links:[]}),connections[d.target[id_var]].primary.nodes.push(d.source),connections[d.target[id_var]].primary.links.push({source:d.target,target:d.source})});for(var c in connections){connections[c].secondary={nodes:[],links:[]},connections[c].primary.nodes.forEach(function(p){connections[p[id_var]].primary.nodes.forEach(function(s){if(s[id_var]!=c){0>connections[c].primary.nodes.indexOf(s)&&0>connections[c].secondary.nodes.indexOf(s)&&connections[c].secondary.nodes.push(s);var dupe=!1;connections[c].secondary.links.forEach(function(l){l.source==s&&l.target==p&&(dupe=!0)}),dupe||connections[c].secondary.links.push({source:p,target:s})}})});var node_check=connections[c].primary.nodes.concat(connections[c].secondary.nodes).concat([connections[c].center]);connections[c].extent={},connections[c].extent.x=d3.extent(d3.values(node_check),function(v){return v.x}),connections[c].extent.y=d3.extent(d3.values(node_check),function(v){return v.y})}return chart},chart.spotlight=function(x){return arguments.length?(spotlight=x,chart):spotlight},chart.highlight=function(x){return arguments.length?(highlight=x,clicked=highlight?!0:!1,chart):highlight},chart.value_var=function(x){return arguments.length?(value_var=x,chart):value_var},chart.id_var=function(x){return arguments.length?(id_var=x,chart):id_var},chart.text_var=function(x){return arguments.length?(text_var=x,chart):text_var},chart},vizwhiz.viz.stacked=function(){function chart(selection){return selection.each(function(data){xaxis_vals=data.reduce(function(a,b){return a.concat(b.year)},[]).filter(function(value,index,self){return self.indexOf(value)===index}),nested_data=nest_data(xaxis_vals,data);var data_max=d3.max(d3.nest().key(function(d){return d.year}).rollup(function(leaves){return d3.sum(leaves,function(d){return d[value_var]})}).entries(data),function(d){return d.values}),x_scale=d3.scale.linear().domain([xaxis_vals[0],xaxis_vals[xaxis_vals.length-1]]).range([0,size.width]),y_scale=d3.scale.linear().domain([0,data_max]).range([size.height,0]),area=d3.svg.area().interpolate("monotone").x(function(d){return x_scale(parseInt(d.key))}).y0(function(d){return y_scale(d.y0)}).y1(function(d){return y_scale(d.y0+d.y)}),svg=d3.select(this).selectAll("svg").data([data]),svg_enter=svg.enter().append("svg").attr("width",width).attr("height",height),viz_enter=svg_enter.append("g").attr("class","viz").attr("transform","translate("+size.x+","+size.y+")");viz_enter.append("rect").style("stroke","#000").style("stroke-width",1).style("fill","#efefef").attr("class","background").attr("width",size.width).attr("height",size.height).attr("x",0).attr("y",0);var xaxis_enter=viz_enter.append("g").attr("class","xaxis").attr("transform","translate(0,"+size.height+")");d3.select(".xaxis").call(x_axis.scale(x_scale).ticks(xaxis_vals.length)),xaxis_enter.append("text").attr("width",size.width).attr("x",size.width/2).attr("y",60).attr("class","axis_title x").attr("text-anchor","middle").style("font-weight","bold").attr("font-size","14px").attr("font-family","Helvetica").attr("fill","#4c4c4c").text(xaxis_label);var yaxis_enter=viz_enter.append("g").attr("class","yaxis");d3.select(".yaxis").call(y_axis.scale(y_scale)),yaxis_enter.append("text").attr("width",size.width).attr("class","axis_title y").attr("text-anchor","middle").style("font-weight","bold").attr("font-size","14px").attr("font-family","Helvetica").attr("fill","#4c4c4c").attr("transform","translate("+(-size.x+25)+","+(size.y+size.height/2)+") rotate(-90)").text(yaxis_label);var layers=stack(nested_data),paths=d3.select("g.viz").selectAll(".layer").data(layers,function(d){return d.key});paths.enter().append("path").attr("class","layer").attr("fill-opacity",.8).attr("stroke-width",1).attr("stroke","#ffffff").attr("fill",function(d){return d.color}).attr("d",function(d){return area(d.values)}),paths.attr("fill",function(d){return d.color}).attr("d",function(d){return area(d.values)}),paths.exit().remove();var text_layers=[],text_height_scale=d3.scale.linear().range([0,1]).domain([0,data_max]);layers.forEach(function(layer){var tallest=d3.max(layer.values,function(d){return d.y});tallest=layer.values.filter(function(d){return d.y==tallest})[0],text_height_scale(tallest.y)>.06&&(layer.tallest=tallest,text_layers.push(layer))});var texts=d3.select("g.viz").selectAll(".label").data(text_layers,function(d){return d.key});texts.enter().append("text").attr("class","label").style("font-weight","bold").attr("font-size","14px").attr("font-family","Helvetica").attr("x",function(d){var pad=0,values_index=d.values.indexOf(d.tallest);return 0==values_index&&(pad+=10),values_index==d.values.length-1&&(pad-=10),x_scale(d.tallest.key)+pad}).attr("dy",6).attr("y",function(d){d=d.tallest;var height=y_scale(d.y0-d.y)-y_scale(d.y0+d.y);return y_scale(d.y0+d.y)+height/4}).attr("text-anchor",function(d){var values_index=d.values.indexOf(d.tallest);return 0==values_index?"start":values_index==d.values.length-1?"end":"middle"}).attr("fill",function(){return"white"}).text(function(d){return d[nesting[nesting.length-1]]}),texts.exit().remove(),viz_enter.append("rect").style("stroke","#000").style("stroke-width",2).style("fill","none").attr("class","border").attr("width",size.width).attr("height",size.height).attr("x",0).attr("y",0),d3.select("rect.border").node().parentNode.appendChild(d3.select("rect.border").node())}),chart}function nest_data(xaxis_vals,data){var nest_key=nesting[nesting.length-1],info_lookup={},nested=d3.nest().key(function(d){return d[nest_key]}).rollup(function(leaves){info_lookup[leaves[0][nest_key]]=JSON.parse(JSON.stringify(leaves[0])),delete info_lookup[leaves[0][nest_key]][xaxis_var],delete info_lookup[leaves[0][nest_key]][value_var];var values=d3.nest().key(function(d){return d.year}).rollup(function(l){return d3.sum(l,function(d){return d[value_var]})}).entries(leaves);return years_available=values.reduce(function(a,b){return a.concat(b.key)},[]).filter(function(y,i,arr){return arr.indexOf(y)==i}),xaxis_vals.forEach(function(y){0>years_available.indexOf(""+y)&&values.push({key:""+y,values:0})}),values.sort(function(a,b){return a.key-b.key})}).entries(data);return nested.forEach(function(d,i){d.total=d3.sum(d.values,function(dd){return dd.values}),nested[i]=vizwhiz.utils.merge(d,info_lookup[d.key])}),nested}var margin={top:5,right:40,bottom:20,left:120},width=window.innerWidth,height=window.innerHeight,size={width:width-margin.left-margin.right,height:height-margin.top-margin.bottom,x:margin.left,y:margin.top},depth=null,value_var=null,id_var=null,text_var=null,xaxis_var=null,xaxis_label="",yaxis_label="",nesting=[],dispatch=d3.dispatch("elementMouseover","elementMouseout"),stack=d3.layout.stack().offset("zero").values(function(d){return d.values}).x(function(d){return parseInt(d.key)}).y(function(d){return d.values}),x_axis=d3.svg.axis().tickSize(0).tickPadding(15).orient("bottom").tickFormat(function(d){return d3.select(this).attr("text-anchor","middle").style("font-weight","bold").attr("font-size","12px").attr("font-family","Helvetica").attr("fill","#4c4c4c"),d3.select(this.parentNode).append("line").attr("class","tick_line").attr("x1",0).attr("x2",0).attr("y1",1).attr("y2",10).attr("stroke","#000").attr("stroke-width",1),d}),y_axis=d3.svg.axis().tickSize(0).tickPadding(15).orient("left").tickFormat(function(d){return d3.select(this).attr("text-anchor","middle").style("font-weight","bold").attr("font-size","12px").attr("font-family","Helvetica").attr("fill","#4c4c4c"),d3.select(this.parentNode).append("line").attr("class","tick_line").attr("x1",1).attr("x2",0+size.width-1).attr("y1",0).attr("y2",0).attr("stroke","#ccc").attr("stroke-width",.5),d3.select(this.parentNode).append("line").attr("class","tick_line").attr("x1",-10).attr("x2",-1).attr("y1",0).attr("y2",0).attr("stroke","#000").attr("stroke-width",1),vizwhiz.utils.format_num(d,!1,3,!0)});return chart.dispatch=dispatch,chart.width=function(x){return arguments.length?(width=x,chart):width},chart.height=function(x){return arguments.length?(height=x,chart):height},chart.depth=function(x){return arguments.length?(depth=x,chart):depth},chart.value_var=function(x){return arguments.length?(value_var=x,chart):value_var},chart.id_var=function(x){return arguments.length?(id_var=x,chart):id_var},chart.text_var=function(x){return arguments.length?(text_var=x,chart):text_var},chart.xaxis_var=function(x){return arguments.length?(xaxis_var=x,chart):xaxis_var},chart.xaxis_label=function(x){return arguments.length?(xaxis_label=x,chart):xaxis_label},chart.yaxis_label=function(x){return arguments.length?(yaxis_label=x,chart):yaxis_label},chart.nesting=function(x){return arguments.length?(nesting=x,chart):nesting},chart.margin=function(x){return arguments.length?(margin.top=x.top!==void 0?x.top:margin.top,margin.right=x.right!==void 0?x.right:margin.right,margin.bottom=x.bottom!==void 0?x.bottom:margin.bottom,margin.left=x.left!==void 0?x.left:margin.left,size.width=width-margin.left-margin.right,size.height=height-margin.top-margin.bottom,size.x=margin.left,size.y=margin.top,chart):margin},chart},vizwhiz.viz.tree_map=function(){function chart(selection){return selection.each(function(data){var cloned_data=JSON.parse(JSON.stringify(data)),svg=d3.select(this).selectAll("svg").data([data]),svg_enter=svg.enter().append("svg").attr("width",width).attr("height",height),tmap_data=d3.layout.treemap().round(!1).size([width,height]).children(function(d){return d.children}).sort(function(a,b){return a.value-b.value}).value(function(d){return value_var?d[value_var]:d.value}).nodes(cloned_data),max_depth=d3.max(tmap_data,function(d){return d.depth});tmap_data=tmap_data.filter(function(d){return d.depth===(depth||max_depth)}),svg_enter.append("clipPath").attr("id","clipping").append("rect").attr("width",width).attr("height",height),d3.select("#clipping rect").transition(750).attr("width",width).attr("height",height),svg_enter.append("g").attr("class","viz").attr("clip-path","url(#clipping)");var cell=d3.select("g.viz").selectAll("g").data(tmap_data,function(d){return id_var?d[id_var]:d.id}),cell_enter=cell.enter().append("g").attr("transform",function(d){return"translate("+d.x/2+","+d.y/2+")"});cell_enter.append("rect").attr("stroke","#ffffff").attr("width",function(d){return d.dx+"px"}).attr("height",function(d){return d.dy+"px"}).attr("fill",function(d){for(;!d.color&&d.children;)d=d.children[0];return d.color?d.color:vizwhiz.utils.rand_color()}),cell_enter.append("text").attr("text-anchor","start").style("font-weight","bold").attr("font-family","Helvetica").attr("class","name").attr("x","0.2em").attr("y","0em").attr("dy","1em").attr("fill",function(d){return d.text_color?d.text_color:d3.hsl(d.color).l>.6?"#333":"#fff"}).each(function(d){var text=text_var?d[text_var]:d.name;text&&vizwhiz.utils.wordWrap(text,this,d.dx,d.dy,!0)}),cell_enter.append("text").attr("class","share").attr("text-anchor","middle").style("font-weight","bold").attr("font-family","Helvetica").attr("fill",function(d){return d.text_color?d.text_color:d3.hsl(d.color).l>.6?"#333":"#fff"}).text(function(d){for(var root=d;root.parent;)root=root.parent;return vizwhiz.utils.format_num(d.value/root.value,!0,2)}).attr("font-size",function(d){var size=d.dx/7;if(d.dx<d.dy)var size=d.dx/7;else var size=d.dy/7;return size}).attr("x",function(d){return d.dx/2}).attr("y",function(d){return d.dy-.1*parseInt(d3.select(this).attr("font-size"),10)}),cell.attr("transform",function(d){return"translate("+d.x+","+d.y+")"}).each(function(g_data){d3.select(this).selectAll("rect").attr("width",function(){return g_data.dx+"px"}).attr("height",function(){return g_data.dy+"px"}),d3.select(this).selectAll("text.name").each(function(){{text_var?g_data[text_var]:g_data.name}}),d3.select(this).selectAll("text.share").text(function(){for(var root=g_data;root.parent;)root=root.parent;return vizwhiz.utils.format_num(g_data.value/root.value,!0,2)}).attr("font-size",function(){var size=g_data.dx/7;if(g_data.dx<g_data.dy)var size=g_data.dx/7;else var size=g_data.dy/7;return size}).attr("x",function(){return g_data.dx/2}).attr("y",function(){return g_data.dy-.1*parseInt(d3.select(this).attr("font-size"),10)})}),cell.exit().remove()}),chart}var margin={top:0,right:0,bottom:0,left:0},width=window.innerWidth,height=window.innerHeight,depth=null,value_var=null,id_var=null,text_var=null,dispatch=d3.dispatch("elementMouseover","elementMouseout");return chart.dispatch=dispatch,chart.width=function(x){return arguments.length?(width=x,chart):width},chart.height=function(x){return arguments.length?(height=x,chart):height},chart.depth=function(x){return arguments.length?(depth=x,chart):depth},chart.value_var=function(x){return arguments.length?(value_var=x,chart):value_var},chart.id_var=function(x){return arguments.length?(id_var=x,chart):id_var},chart.text_var=function(x){return arguments.length?(text_var=x,chart):text_var},chart.margin=function(x){return arguments.length?(margin.top=x.top!==void 0?x.top:margin.top,margin.right=x.right!==void 0?x.right:margin.right,margin.bottom=x.bottom!==void 0?x.bottom:margin.bottom,margin.left=x.left!==void 0?x.left:margin.left,chart):margin},chart};