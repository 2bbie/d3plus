<!DOCTYPE html>
<meta charset="utf-8">
<link href="../src/vizwhiz.css" rel="stylesheet" type="text/css">
<style>

body {
  margin: 0; padding:0;
}

</style>
<body>

<div id="viz"></div>

<script src="../lib/d3.js"></script>
<script src="../lib/modernizr.custom.js"></script>
<script src="../src/general.js"></script>
<script src="../src/utils.js"></script>
<script src="../src/tooltip.js"></script>
<script src="../src/viz/stacked.js"></script>
<script>

var width = 960,
  height = 550;

var sample_data = [
  {"continent": "South America", "country": "Brazil", "year": 1999, "value": 3938, "color": "#43f9c2", "state": "mg"},
  {"continent": "South America", "country": "Brazil", "year": 2000, "value": 3938, "color": "#43f9c2", "state": "mg"},
  {"continent": "South America", "country": "Brazil", "year": 2001, "value": 3938, "color": "#43f9c2", "state": "mg"},
  {"continent": "South America", "country": "Brazil", "year": 1999, "value": 3938, "color": "#43f9c2", "state": "rr"},
  {"continent": "South America", "country": "Brazil", "year": 2000, "value": 3938, "color": "#43f9c2", "state": "rr"},
  {"continent": "South America", "country": "Brazil", "year": 2001, "value": 3938, "color": "#43f9c2", "state": "rr"},
  {"continent": "South America", "country": "Brazil", "year": 1999, "value": 3938, "color": "#43f9c2", "state": "sp"},
  {"continent": "South America", "country": "Brazil", "year": 2000, "value": 3938, "color": "#43f9c2", "state": "sp"},
  {"continent": "South America", "country": "Brazil", "year": 2001, "value": 3938, "color": "#43f9c2", "state": "sp"},
  {"continent": "South America", "country": "Bolivarian Republic of Venezuela", "year": 1999, "value": 3812, "color": "#43f9c2", "state": "a"},
  {"continent": "South America", "country": "Bolivarian Republic of Venezuela", "year": 2000, "value": 3812, "color": "#43f9c2", "state": "a"},
  {"continent": "South America", "country": "Bolivarian Republic of Venezuela", "year": 2001, "value": 3812, "color": "#43f9c2", "state": "a"},
  {"continent": "South America", "country": "Peru", "year": 1999, "value": 743, "color": "#43f9c2", "state": "p"},
  {"continent": "South America", "country": "Peru", "year": 2000, "value": 743, "color": "#43f9c2", "state": "p"},
  {"continent": "South America", "country": "Peru", "year": 2001, "value": 743, "color": "#43f9c2", "state": "p"},
  {"continent": "North America", "country": "Mexico", "year": 1999, "value": 3534, "color": "#ca3422", "state": "m"},
  {"continent": "North America", "country": "Mexico", "year": 2000, "value": 3534, "color": "#ca3422", "state": "m"},
  {"continent": "North America", "country": "Mexico", "year": 2001, "value": 3534, "color": "#ca3422", "state": "m"},
  {"continent": "North America", "country": "United States of America", "year": 1999, "value": 5731, "color": "#ca3422", "state": "ma"},
  {"continent": "North America", "country": "United States of America", "year": 2000, "value": 5731, "color": "#ca3422", "state": "ma"},
  // test with missing data
  // {"continent": "North America", "country": "United States of America", "year": 2001, "value": 5731, "color": "#ca3422", "state": "ma"},
  // {"continent": "North America", "country": "United States of America", "year": 1999, "value": 5731, "color": "#ca3422", "state": "ny"},
  {"continent": "North America", "country": "United States of America", "year": 2000, "value": 5731, "color": "#ca3422", "state": "ny"},
  {"continent": "North America", "country": "United States of America", "year": 2001, "value": 5731, "color": "#ca3422", "state": "ny"}
]

var viz = vizwhiz.viz.stacked()
  .nesting(["nesting_0", "nesting_1"])
  .xaxis_var("year")
  .value_var("val_usd")
  .title("Title of the chart")
  .tooltip_info(["id", "complexity", "distance"])
  .text_var("name")
  .id_var("id")

d3.json("data/products_mg.json", function(flat_data){
  d3.json("data/attr_hs.json", function(attrs){

    flat_data.map(function(d, i){
      d.nesting_0 = {"name":attrs[d.id.slice(0, 2)].name, "id":d.id.slice(0, 2)};
      d.nesting_1 = {"name":attrs[d.id.slice(0, 4)].name, "id":d.id.slice(0, 4)};
      d.nesting_2 = {"name":attrs[d.id.slice(0, 6)].name, "id":d.id.slice(0, 6)};
      flat_data[i] = vizwhiz.utils.merge(d, attrs[d.id]);
    })
    // console.log(flat_data)
    
    var data2010 = flat_data.filter(function(d){return d.year == 2010})
    var nested2010 = vizwhiz.utils.nest(data2010, ["nesting_0"], true,
        [{"key":"val_usd", "agg":"sum"}, {"key":"color"}, {"key":"year"}])
    
    var data2009 = flat_data.filter(function(d){return d.year == 2009})
    var nested2009 = vizwhiz.utils.nest(data2009, ["nesting_0"], true,
        [{"key":"val_usd", "agg":"sum"}, {"key":"color"}, {"key":"year"}])
    
    var data2008 = flat_data.filter(function(d){return d.year == 2008})
    var nested2008 = vizwhiz.utils.nest(data2008, ["nesting_0"], true,
        [{"key":"val_usd", "agg":"sum"}, {"key":"color"}, {"key":"year"}])
    
    var data2007 = flat_data.filter(function(d){return d.year == 2007})
    var nested2007 = vizwhiz.utils.nest(data2007, ["nesting_0"], true,
        [{"key":"val_usd", "agg":"sum"}, {"key":"color"}, {"key":"year"}])
        
    var data = nested2007.concat(nested2008).concat(nested2009).concat(nested2010)
    
    
    d3.select("#viz")
      .datum(data)
      .call(viz)
    
//     var nested_data = d3.nest()
//       .key(function(d){
//         return d.id.substr(0, 2);
//       })
//       .key(function(d){
//         return d.id.substr(0, 4);
//       })
//       .entries(flat_data).map(renameKeyValue);
//   
//     setTimeout(function(){
//       d3.select("#viz")
//         .datum({"name":"top", "children": nested_data})
//         .call(viz.text_var("name").id_var("id"))
//     },1000)
//     
  })
})

</script>