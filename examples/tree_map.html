<!DOCTYPE html>
<meta charset="utf-8">
<link href="../src/vizwhiz.css" rel="stylesheet" type="text/css">
<style>

body {
  
}

</style>
<body>

<div id="viz"></div>

<script src="../lib/d3.js"></script>
<script src="../lib/modernizr.custom.js"></script>
<script src="../src/general.js"></script>
<script src="../src/utils.js"></script>
<script src="../src/viz/tree_map.js"></script>
<script>

var width = 960,
  height = 550,
  margin = {top: 5, right: 40, bottom: 20, left: 120};

var viz = vizwhiz.viz.tree_map()
  .text_var("name")
  .id_var("name")
  .width(width - margin.right - margin.left)
  .height(height - margin.top - margin.bottom);


var sample_nested_data = {
  "name": "Top",
  "children": [
    {
      "name": "Countries",
      "children": [
      {
        "name": "South America",
        "children": [
            {"name": "Brazil", "value": 3938, "color": "#43f9c2"},
            {"name": "Bolivarian Republic of Venezuela", "value": 3812, "color": "#43f9c2"},
            {"name": "Peru", "value": 743, "color": "#43f9c2"}
          ]
        },
        {
          "name": "North America",
          "children": [
            {"name": "Mexico", "value": 3534, "color": "#ca3422"},
            {"name": "United States of America", "value": 5731, "color": "#ca3422"}
          ]
        }
      ]
    }
  ]
}

function renameKeyValue(obj) { 
  if (obj.values && obj.values.length) { 
    return { 
      'name': obj.key, 
      'id': obj.key, 
      'children': obj.values.map(function(obj) { 
        return renameKeyValue(obj); 
      }) 
    }; 
  } else { 
    return obj; 
  }
}

d3.select("#viz")
  .datum(sample_nested_data)
  .call(viz)

d3.select('body').on('click', window.transition);

d3.json("data/products_mg.json", function(flat_data){

  d3.json("data/attr_hs.json", function(attrs){

    flat_data = flat_data.filter(function(d){
      return d.year == 2010;
    })

    flat_data.map(function(d, i){
      d.value = d.val_usd;
      flat_data[i] = vizwhiz.utils.merge(d, attrs[d.id]);
    })
  
    var nested_data = d3.nest()
      .key(function(d){
        return d.id.substr(0, 2);
      })
      .key(function(d){
        return d.id.substr(0, 4);
      })
      .entries(flat_data).map(renameKeyValue);
  
    setTimeout(function(){
      d3.select("#viz")
        .datum({"name":"top", "children": nested_data})
        .call(viz.text_var("name").id_var("id"))
    },1000)
    
  })
  
})

</script>