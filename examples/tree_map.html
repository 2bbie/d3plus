<!DOCTYPE html>
<meta charset="utf-8">
<link href="../src/vizwhiz.css" rel="stylesheet" type="text/css">
<style>

body {
  margin: 0; padding:0;
}

</style>
<body>

<div id="viz"></div>

<script src="../lib/d3.js"></script>
<script src="../lib/modernizr.custom.js"></script>
<script src="../src/general.js"></script>
<script src="../src/utils.js"></script>
<script src="../src/tooltip.js"></script>
<script src="../src/viz/viz.js"></script>
<script src="../src/viz/tree_map.js"></script>
<script>

var viz = vizwhiz.viz()

d3.json("data/products_mg.json", function(raw_data){
  d3.json("data/attr_hs.json", function(attrs){

    var flat_data = raw_data.filter(function(d){
      return d.year == 2010;
    })
    
    flat_data.map(function(d, i){
      d.nesting_0 = {"name":attrs[d.id.slice(0, 2)].name, "id":d.id.slice(0, 2)};
      d.nesting_1 = {"name":attrs[d.id.slice(0, 4)].name, "id":d.id.slice(0, 4)};
      d.nesting_2 = {"name":attrs[d.id.slice(0, 6)].name, "id":d.id.slice(0, 6)};
      d.value = d.val_usd;
      flat_data[i] = vizwhiz.utils.merge(d, attrs[d.id]);
    })
    
    var nested_data = vizwhiz.utils.nest(
      flat_data, 
      ["nesting_0","nesting_1","nesting_2"], 
      false, 
      [{"key":"color"},{"key":"value", "agg":"sum"}])
      
    viz
      .type("tree_map")
      .id_var("id")
      .text_var("name")
      .value_var("value")
      .tooltip_info(["distance", "complexity", "value"])
      .name_array(["name","id"])
      .total_bar({"prefix": "Export Value: $", "suffix": " USD", "format": ",f"})
      
    d3.select("#viz")
      .datum(nested_data)
      .call(viz)
    
    // setTimeout(function(){
    //   
    //   // test for animating between years
    //   var new_data = raw_data.filter(function(d){
    //     return d.year == 2005;
    //   })
    // 
    //   new_data.map(function(d, i){
    //     d.value = d.val_usd;
    //     d.nesting_0 = {"name":attrs[d.id.slice(0, 2)].name, "id":d.id.slice(0, 2)};
    //     d.nesting_1 = {"name":attrs[d.id.slice(0, 4)].name, "id":d.id.slice(0, 4)};
    //     d.nesting_2 = {"name":attrs[d.id.slice(0, 6)].name, "id":d.id.slice(0, 6)};
    //     new_data[i] = vizwhiz.utils.merge(d, attrs[d.id]);
    //   })
    //   
    //   var data_2005 = vizwhiz.utils.nest(new_data, ["nesting_0","nesting_1","nesting_2"], false, [{"key":"color"}])
    //   d3.select("#viz")
    //     .datum(data_2005)
    //     .call(viz)
    //   
    // },4000)
    
  })
})

</script>