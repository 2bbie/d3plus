<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link href="../src/vizwhiz.css" rel="stylesheet" type="text/css">
  <style>

  body {
    margin: 0px;
  }

  </style>
</head>
<body>

<div id="viz"></div>

<script src="../lib/d3.js"></script>
<script src="../lib/modernizr.custom.js"></script>
<script src="../src/general.js"></script>
<script src="../src/utils.js"></script>
<script src="../src/viz/network.js"></script>
<script>

  var width = window.innerWidth,
      height = window.innerHeight,
      viz_nodes = [
          {"id": "a", "x": 20, "y": 25},
          {"id": "b", "x": 30, "y": 40},
          {"id": "c", "x": 40, "y": 20},
          {"id": "d", "x": 50, "y": 30},
          {"id": "e", "x": 10, "y": 35}
        ],
      viz_links = [
          {"source": viz_nodes[0], "target": viz_nodes[1]},
          {"source": viz_nodes[1], "target": viz_nodes[2]},
          {"source": viz_nodes[2], "target": viz_nodes[0]},
          {"source": viz_nodes[2], "target": viz_nodes[3]},
          {"source": viz_nodes[4], "target": viz_nodes[1]},
          {"source": viz_nodes[4], "target": viz_nodes[0]},
          {"source": viz_nodes[3], "target": viz_nodes[0]}
        ],
      data = {
          "a": {"name": "AgglomerativeCluster", "value": 0, "color": "#ff0000", "active": false},
          "b": {"name": "CommunityStructure", "value": 3812, "color": "#00ff00", "active": true},
          "c": {"name": "MergeEdge", "value": 1400, "color": "#0000ff", "active": true},
          "d": {"name": "MergeEdge", "value": 3500, "color": "#00ffff", "active": true},
          "e": {"name": "MergeEdge", "value": 803, "color": "#ff00ff", "active": false}
        },
      data2 = {
          "a": {"name": "AgglomerativeCluster", "value": 1000, "color": "#ff0000", "active": true},
          "b": {"name": "CommunityStructure", "value": 1500, "color": "#00ff00", "active": true},
          "c": {"name": "MergeEdge", "value": 600, "color": "#0000ff", "active": false},
          "d": {"name": "MergeEdge", "value": 0, "color": "#00ffff", "active": false},
          "e": {"name": "MergeEdge", "value": 2000, "color": "#ff00ff", "active": true}
        }
        
  // var viz = vizwhiz.viz.network()
  //   .width(width)
  //   .height(height)
  //   .nodes(viz_nodes)
  //   .links(viz_links);
  //             
  // d3.select("#viz")
  //   .datum(data)
  //   .call(viz);
    
  d3.json("data/attr_hs.json", function(attr) {
    d3.json("data/network_hs.json", function(hs) {
      viz_nodes = hs.nodes
      viz_links = hs.edges
      viz_links.forEach(function(link){
        link.source = viz_nodes[link.source]
        link.target = viz_nodes[link.target]
      })
      d3.json("data/products_mg.json", function(ps_data) {
        ps_data = ps_data.filter(function(d){ return d.year == 2010; })
        data = {}
        viz_nodes.forEach(function(d){
          data[d.id] = ps_data.filter(function(f){return f.id == d.id})[0]
          data[d.id] = vizwhiz.utils.merge(data[d.id],attr[d.id])
          data[d.id].rca = get_rca(data[d.id])
          data[d.id].active = data[d.id].rca >= 1 ? true : false
          delete data[d.id].year
          delete data[d.id].bra_val_kg
          delete data[d.id].bra_val_quantity
          delete data[d.id].bra_val_usd
          delete data[d.id].wld_val_usd
          delete data[d.id].attr_type
        })
        
        viz = vizwhiz.viz.network()
          .width(width)
          .height(height)
          .nodes(viz_nodes)
          .links(viz_links)
          .value_var("val_usd");
          
        d3.select("#viz")
          .datum(data)
          .call(viz);
          
        function get_rca(item){
    
          var rca_name = "val_usd", rca_denom = "bra"
        
          if (!item || !item[rca_name]) return 0

          var numerator = item[rca_name] / d3.sum(ps_data,function(d){return d[rca_name]});
          if(rca_denom == "bra"){
            var denominator = item["bra_"+rca_name] / d3.sum(ps_data,function(d){return d["bra_"+rca_name]});
          }
          else {
            var denominator = item["wld_"+rca_name] / d3.sum(ps_data,function(d){return d["wld_"+rca_name]});
          }
                
          if(denominator != 0){
            return numerator / denominator;
          }
          return 0;
        }
    
      })
    })
  });
  

</script>
</body>
</html>