<!DOCTYPE html>
<meta charset="utf-8">
<link href="../src/vizwhiz.css" rel="stylesheet" type="text/css">
<style>

body {
  margin: 0; padding:0;
}

</style>
<body>

<div id="viz"></div>

<script src="../lib/d3.js"></script>
<script src="../lib/modernizr.custom.js"></script>
<script src="../src/general.js"></script>
<script src="../src/utils.js"></script>
<script src="../src/tooltip.js"></script>
<script src="../src/viz/pie_scatter.js"></script>

<script>

var viz = vizwhiz.viz.pie_scatter()

d3.json("data/products_mg.json", function(flat_data){
  d3.json("data/attr_hs.json", function(attrs){

    data2010 = flat_data.filter(function(d){
      return d.year == 2010;
    })

    data2010.map(function(d, i){
      d.active = Math.floor(Math.random()*2);
      d.nesting_0 = {"name":attrs[d.id.slice(0, 2)].name, "id":d.id.slice(0, 2)};
      d.nesting_1 = {"name":attrs[d.id.slice(0, 4)].name, "id":d.id.slice(0, 4)};
      d.nesting_2 = {"name":attrs[d.id.slice(0, 6)].name, "id":d.id.slice(0, 6)};
      // d.value = d.val_usd;
      data2010[i] = vizwhiz.utils.merge(d, attrs[d.id]);
    })
    
    // nest the flat data by nesting array
    var nested2010 = vizwhiz.utils.nest(data2010, ["nesting_0"], true,
        [{"key":"val_usd", "agg":"sum"}, {"key":"complexity", "agg":"avg"}, {"key":"distance", "agg":"avg"}, {"key":"color"}])

    data2003 = flat_data.filter(function(d){
      return d.year == 2003;
    })

    data2003.map(function(d, i){
      d.active = Math.floor(Math.random()*2);
      d.nesting_0 = {"name":attrs[d.id.slice(0, 2)].name, "id":d.id.slice(0, 2)};
      d.nesting_1 = {"name":attrs[d.id.slice(0, 4)].name, "id":d.id.slice(0, 4)};
      d.nesting_2 = {"name":attrs[d.id.slice(0, 6)].name, "id":d.id.slice(0, 6)};
      // d.value = d.val_usd;
      data2003[i] = vizwhiz.utils.merge(d, attrs[d.id]);
    })
    
    // nest the flat data by nesting array
    var nested2003 = vizwhiz.utils.nest(data2003, ["nesting_0","nesting_1"], true,
        [{"key":"val_usd", "agg":"sum"}, {"key":"complexity", "agg":"avg"}, {"key":"distance", "agg":"avg"}, {"key":"color"}])

    viz
      .text_var("name")
      .id_var("id")
      .xaxis_var("distance")
      .xaxis_domain(d3.extent(flat_data,function(d){return d.distance}))
      .yaxis_var("complexity")
      .yaxis_domain(d3.extent(flat_data,function(d){return d.complexity}).reverse())
      .value_var("val_usd")
      .tooltip_info(["distance", "complexity", "value"])

    d3.select("#viz")
      .datum(nested2010)
      .call(viz)   
    
    setTimeout(function(){
      
      d3.select("#viz")
        .datum(nested2003)
        .call(viz)
      
    },2000)

  })
})

</script>